rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isMe(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // /config/app
    match /config/app {
      allow read: if true;
      allow write: if false;
    }

    // /config/app/profiles/{profileId}
    match /config/app/profiles/{profileId} {
      allow read: if true;
      allow write: if false;
    }

    // /config/app/categories/{categoryId}
    match /config/app/categories/{categoryId} {
      allow read: if true;
      allow write: if false;
    }

    // /config/app/genres/{genreId}
    match /config/app/genres/{genreId} {
      allow read: if true;
      allow write: if false;
    }

    match /users/{uid} {
      allow read: if isMe(uid);
      allow create, update: if isMe(uid);
    }

    match /users/{uid}/favorites/{docId} {
      allow read: if isMe(uid);
      allow create, update, delete: if isMe(uid);
    }

    // 구독 시스템: 사용자 구독 정보
    match /users/{uid}/subscription/current {
      allow read: if isMe(uid);
      allow create, update: if isMe(uid);
    }

    // 구독 시스템: 구독 이력
    match /users/{uid}/subscriptionHistory/{historyId} {
      allow read: if isMe(uid);
      allow create: if isMe(uid);
    }

    // 구독 시스템: 결제 내역
    match /users/{uid}/payments/{paymentId} {
      allow read: if isMe(uid);
      allow create: if isMe(uid);
    }
   
    match /comments/{movieId}/items/{itemId} {
      allow read: if true;
      allow create: if signedIn();
      allow delete: if signedIn() && request.auth.uid == resource.data.userId;
    }

    match /adultFilters/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
